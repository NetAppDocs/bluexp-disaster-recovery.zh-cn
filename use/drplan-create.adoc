---
sidebar: sidebar 
permalink: use/drplan-create.html 
keywords: disaster recovery, bluexp disaster recovery, failover, failback, replicate, fail over, fail back, vmware, vcenter, replication plan, protection, disaster, recovery, virtual machines, vm 
summary: NetApp BlueXP灾难恢复是一种基于云的灾难恢复服务、可自动执行灾难恢复工作流。添加vCenter站点后、即可创建灾难恢复或复制计划。 
---
= 在 BlueXP 灾难恢复中创建复制计划
:hardbreaks:
:allow-uri-read: 
:icons: font
:imagesdir: ../media/use/


[role="lead"]
添加vCenter站点后、即可创建灾难恢复或_Replication pl뮮_。选择源和目标vCenter、选择资源组、然后对应用程序的还原和启动方式进行分组。例如、您可以对与一个应用程序关联的虚拟机(VM)进行分组、也可以对具有类似层的应用程序进行分组。

此类计划有时称为_Blueprints_。

您可以创建复制计划、还可以编辑合规性和测试计划。

您可以保护多个数据存储库上的多个VM。BlueXP  灾难恢复会为托管受保护VM数据存储库的所有ONTAP卷创建ONTAP一致性组。

只有当复制计划处于以下状态之一时、才能保护VM：

* 就绪
* 已提交故障恢复
* 已提交测试故障转移




== 创建计划

向导将引导您完成以下步骤：

* 选择vCenter Server。
* 选择要复制的VM或数据存储库并分配资源组。
* 映射源环境中的资源与目标之间的映射关系。
* 确定重复情况、运行子系统托管的脚本、设置启动顺序并选择恢复点目标。
* 查看计划。


创建计划时、应遵循以下准则：

* 对计划中的所有VM使用相同的凭据。
* 对计划中的所有VM使用相同的脚本。
* 对计划中的所有VM使用相同的子网、DNS和网关。


.开始之前
如果要在此服务中创建SnapMirror关系、则集群及其SVM对等关系应已在BlueXP灾难恢复之外进行设置。



=== 选择vCenter Server

首先、选择源vCenter、然后选择目标vCenter。

.步骤
. 从BlueXP左侧导航栏中、选择*保护*>*灾难恢复*。
. 从BlueXP  灾难恢复顶部菜单中，选择*Replication Plans (复制计划)*，然后选择*Add*(添加)。或者，如果您刚刚开始使用该服务，请从信息板中选择*添加复制计划*。
+
image:dr-plan-create-name.png["显示添加复制计划"]

. 为复制计划创建一个名称。
. 从源vCenter和目标vCenter列表中选择源vCenter和目标vCenter。
. 选择 * 下一步 * 。




=== 选择要复制的应用程序并分配资源组

下一步是将所需的VM或数据存储库分组到功能资源组中。通过资源组、您可以使用通用快照保护一组VM或数据存储库。

在复制计划中选择应用程序时、您可以查看该计划中每个虚拟机或数据存储库的操作系统。这有助于确定如何将虚拟机或数据存储库分组到资源组中。


TIP: 每个资源组可以包含一个或多个VM或数据存储库。

创建资源组时，请考虑以下问题：

* 在将数据存储库添加到资源组之前、请先手动发现VM或按计划发现VM。这样可确保虚拟机已被发现并列在资源组中。如果不触发手动发现、则虚拟机可能不会列在资源组中。
* 确保数据存储库中至少有一个VM。如果数据存储库中没有VM、则不会发现此数据存储库。
* 一个数据存储库不应托管受多个复制计划保护的VM。
* 请勿在同一数据存储库中托管受保护和未受保护的VM。如果受保护和未受保护的VM托管在同一数据存储库中、则可能会出现以下问题：
+
** 由于BlueXP  灾难恢复使用SnapMirror、并且系统会复制整个ONTAP卷、因此出于许可考虑、会使用该卷的已用容量。在这种情况下、此计算将包括受保护虚拟机和未受保护虚拟机占用的卷空间。
** 如果需要将资源组及其关联的数据存储库故障转移到灾难恢复站点、则在故障转移过程中、源站点上将不再存在任何未受保护的VM (不属于资源组、但托管在ONTAP卷上的VM)、从而导致源站点上未受保护的VM发生故障。此外、BlueXP  灾难恢复不会在故障转移vCenter站点上启动这些未受保护的VM。


* 要保护VM、必须将其包含在资源组中。


*最佳实践*：在部署BlueXP  灾难恢复之前组织VM、以最大限度地减少"数据存储库无序增长"。将需要保护的VM放置在一组数据存储库上、将不会受保护的VM放置在另一组数据存储库上。使用基于数据存储库的保护来确保任何给定数据存储库上的虚拟机均受到保护。

.步骤
. 选择*虚拟机*或*存储库*。
. (可选)按名称搜索特定虚拟机或数据存储库。
. 在应用程序页面的左侧、选择要保护的VM或数据存储库并将其分配给选定组。
+
选定资源将自动添加到组1、并启动新的组2。每次向最后一个组添加资源时、都会添加另一个组。

+
image:dr-plan-create-apps-vms6.png["显示\"Add Replication Plan  to replication\"页面的屏幕截图"]

+
或者、对于数据存储库：

+
image:dr-plan-create-apps-datastores.png["显示\"Add Replication Plan  to replication\"页面的屏幕截图"]

. (可选)执行以下任一操作：
+
** 要更改组的名称，请单击组*Edit*image:icon-pencil.png["铅笔图标"]图标。
** 要从组中删除某个资源，请选择该资源旁边的*X*。
** 要将资源移动到其他组，请将其拖放到新组中。
+

TIP: 要将数据存储库移至其他资源组、请取消选择不需要的数据存储库、然后提交复制计划。然后、创建或编辑另一个复制计划并重新选择数据astore。



. 选择 * 下一步 * 。




=== 将源资源映射到目标

在资源映射步骤中、指定源环境中的资源应如何映射到目标。创建复制计划时、您可以为计划中的每个VM设置启动延迟和顺序。这样、您就可以设置VM的启动顺序。

.开始之前
如果要在此服务中创建SnapMirror关系、则集群及其SVM对等关系应已在BlueXP灾难恢复之外进行设置。

.步骤
. 在"Resource MAPPING (资源映射)"页面中、要对故障转移和测试操作使用相同的映射、请选中此框。
+
image:dr-plan-resource-mapping2.png["复制计划、资源映射选项卡"]

. 在故障转移映射选项卡中、选择每个资源右侧的向下箭头并映射每个资源。




=== 映射资源>计算资源部分

选择*计算资源*旁边的向下箭头。

* *源数据中心和目标数据中心*
* *目标集群*
* *目标主机*(可选)：选择集群后、您可以设置此信息。



TIP: 如果vCenter配置了Distributed Resource Scheduler (DRS)来管理集群中的多个主机、则无需选择主机。如果选择主机、则BlueXP  灾难恢复会将所有VM置于选定主机上。**目标VM文件夹*(可选)：创建一个新的根文件夹以存储选定的VM。



=== 映射资源>虚拟网络部分

在故障转移映射选项卡中，选择*Virtual networks*旁边的向下箭头。选择源虚拟LAN和目标虚拟LAN。

选择与相应虚拟LAN的网络映射。虚拟LAN应已配置、因此选择适当的虚拟LAN以映射虚拟机。



=== 映射资源>虚拟机部分

在故障转移映射选项卡中，选择*Virtual Machines*旁边的向下箭头。

VM的默认值已映射。默认映射使用的设置与VM在生产环境中使用的设置相同(相同的IP地址、子网掩码和网关)。

如果对默认设置进行了任何更改、则必须将目标IP字段更改为"与源不同"。


NOTE: 如果将设置更改为"与源不同"、则需要提供VM子操作系统凭据。

根据您的选择、此部分可能会显示不同的字段。

* *IP地址类型*：重新配置VM配置以满足目标虚拟网络要求。BlueXP  灾难恢复提供两种选项：DHCP或静态IP。对于静态IP、请配置子网掩码、网关和DNS服务器。此外、输入VM的凭据。
+
** *DHCP*：如果希望VM从DHCP服务器获取网络配置信息，请选择此设置。如果选择此选项、则只需提供虚拟机的凭据即可。
** *静态IP*：如果要手动指定IP配置信息，请选择此设置。您可以选择以下选项之一："与源相同"、"与源不同"或"子网映射"。如果选择与源相同的、则无需输入凭据。另一方面、如果您选择使用与源不同的信息、则可以提供凭据、VM的IP地址、子网掩码、DNS和网关信息。应在全局级别或每个VM级别提供VM子操作系统凭据。
+
在将大型环境恢复到较小的目标集群时、或者在无需配置一对一物理VMware基础架构的情况下执行灾难恢复测试时、这一点非常有用。

+
image:dr-plan-vm-subnet-option2.png["显示添加复制计划"]



* *目标 IP* 字段，选择以下选项之一：
+
** *与来源相同*
** *与来源不同*
** *子网映射*：如果要将源子网映射到不同的目标子网，请选择此选项。您可以选择源子网，然后选择目标子网。当您想更改目标环境中虚拟机的 IP 地址时，此选项非常有用。
+

NOTE: 使用子网映射是一个可选的两步过程：首先，在“站点”选项卡中为每个 vCenter 站点添加子网映射。其次、在复制计划中、指示您要使用子网映射。

+

NOTE: 如果有两个VM (例如、一个是Linux、另一个是Windows)、则只有Windows才需要凭据。



* *使用 Windows LAPS*：如果您使用 Windows 本地管理员密码解决方案 (Windows LAPS)，请勾选此框。此选项仅在您选择“静态 IP”选项时可用。勾选此框后，您无需为每个虚拟机提供密码，只需提供域控制器详细信息即可。
+
如果您不使用 Windows LAPS，则该虚拟机为 Windows 虚拟机，并且虚拟机行上的凭据选项已启用。您可以提供该虚拟机的凭据。

* *脚本*：您可以将.sh、.bat或.ps1格式的自定义脚本作为故障转移后进程。通过自定义脚本、您可以在故障转移过程之后让BlueXP灾难恢复运行脚本。例如、您可以使用自定义脚本在故障转移完成后恢复所有数据库事务。
* *目标VM前缀和后缀*：在虚拟机详细信息下、您可以选择为VM名称添加前缀和后缀。
* *源VM CPU和RAM*：在虚拟机详细信息下，您可以选择调整VM CPU和RAM参数的大小。
+
image:dr-plan-resource-mapping-vm-boot-order.png["显示添加复制计划"]

* *Boot Order*：您可以在故障转移后修改资源组中所有选定虚拟机的启动顺序。默认情况下、所有VM会并行启动；但是、您可以在此阶段进行更改。这有助于确保优先级为一个的所有虚拟机在后续优先级为VM启动之前都在运行。
+
所有具有相同启动顺序编号的VM都将并行启动。

+
** 顺序启动：为每个VM分配一个唯一编号、以便按分配的顺序启动、例如1、2、3、4、5。
** 同时启动：为任何VM分配相同数量的虚拟机、以便同时启动它们、例如1、1、1、1、2、2、3、4、4。


* *Boot Delay*：调整启动操作的延迟(以分钟为单位)。
+

TIP: 要将启动顺序重置为默认值，请选择*将VM设置重置为默认值*，然后选择要更改回默认值的设置。

* *创建应用程序一致的副本*：指示是否创建应用程序一致的Snapshot副本。该服务将使应用程序处于静修状态、然后创建一个快照、以获得一致的应用程序状态。在Windows上运行的Oracle以及在Windows上运行的Linux和SQL Server支持此功能。




=== 映射资源>存储库部分

选择*存储库*旁边的向下箭头。根据VM的选择、系统会自动选择数据存储库映射。

此部分可能已启用或禁用、具体取决于您的选择。

image:dr-plan-datastore-platform.png["显示添加复制计划"]

* *使用平台管理的备份和保留计划*：如果使用外部快照管理解决方案，请选中此框。BlueXP  灾难恢复支持使用外部快照管理解决方案、例如本机ONTAP SnapMirror策略计划程序或第三方集成。如果复制计划中的每个数据存储库(卷)都已具有在其他位置管理的SnapMirror关系、则可以在BlueXP  灾难恢复中使用这些快照作为恢复点。
+
选中时、BlueXP  灾难恢复不会配置备份计划。但是、您仍需要配置保留计划、因为仍可能会为测试、故障转移和故障恢复操作创建快照。

+
配置此功能后、该服务不会定期创建任何计划的快照、而是依靠外部实体创建和更新这些快照。

* *开始时间*：输入希望备份和保留开始运行的日期和时间。
* *运行间隔*：输入时间间隔(以小时和分钟为单位)。例如、如果输入1小时、则此服务将每小时创建一个快照。
* *保留数量*：输入要保留的快照数量。
* *源和目标数据存储库*：如果存在多个(扇出) SnapMirror关系、则可以选择要使用的目标。如果卷已建立SnapMirror关系、则会显示相应的源数据存储库和目标数据存储库。如果某个卷没有SnapMirror关系、您可以通过选择目标集群、选择目标SVM并提供卷名称来立即创建一个SVM关系。此服务将创建卷和SnapMirror关系。
+

NOTE: 如果要在此服务中创建SnapMirror关系、则集群及其SVM对等关系应已在BlueXP灾难恢复之外进行设置。

+
** 如果VM来自同一个卷和同一个SVM、则该服务将执行标准ONTAP快照并更新二级目标。
** 如果VM来自不同的卷和同一个SVM、则该服务会通过包含所有卷来创建一致性组快照并更新二级目标。
** 如果VM来自不同的卷和不同的SVM、则该服务会通过将所有卷包含在相同或不同集群中来执行一致性组开始阶段和提交阶段快照、并更新二级目标。
** 在故障转移期间、您可以选择任何快照。如果您选择最新快照、该服务将创建按需备份、更新目标、并使用该快照进行故障转移。






=== 添加测试故障转移映射

.步骤
. 要为测试环境设置不同的映射，请取消选中该框并选择*Test Mappings *选项卡。
. 像以往一样浏览每个选项卡、但这次是针对测试环境。
+
在测试映射选项卡上、虚拟机和存储库映射处于禁用状态。

+

TIP: 您可以稍后测试整个计划。现在、您要为测试环境设置映射。





=== 查看复制计划

最后、花几分钟时间查看复制计划。


TIP: 您可以稍后禁用或删除复制计划。

.步骤
. 查看每个选项卡中的信息：计划详细信息、故障转移映射和VM。
. 选择*添加计划*。
+
该计划将添加到计划列表中。





== 编辑计划以测试合规性并确保故障转移测试正常运行

您可能需要设置计划来测试合规性和故障转移测试、以确保这些测试在您需要时能够正常工作。

* *合规性时间影响*：创建复制计划时，服务会默认创建合规性计划。默认合规时间为30分钟。要更改此时间、您可以使用编辑复制计划中的计划。
* *测试故障转移影响*：您可以根据需要或按计划测试故障转移过程。这样、您就可以测试虚拟机向复制计划中指定的目标进行故障转移的情况。
+
测试故障转移会创建FlexClone卷、挂载数据存储库并移动该数据存储库上的工作负载。测试故障转移操作不会影响生产工作负载、测试站点上使用的SnapMirror关系以及必须继续正常运行的受保护工作负载。



根据该计划、故障转移测试将运行、并确保工作负载移动到复制计划指定的目标。

.步骤
. 从BlueXP灾难恢复顶部菜单中、选择*复制计划*。
+
image:dr-plan-list.png["显示复制计划列表的屏幕截图"]

. 选择*操作* image:icon-horizontal-dots.png["水平点操作菜单"] 图标并选择*编辑计划*。
. 输入希望BlueXP灾难恢复检查测试合规性的频率(以分钟为单位)。
. 要检查故障转移测试是否运行正常，请选中*按每月计划运行故障转移*。
+
.. 选择要运行这些测试的日期和时间。
.. 以yyy-mm-dd格式输入要开始测试的日期。
+
image:dr-plan-schedule-edit2.png["屏幕截图、显示可在其中编辑计划的位置"]



. *使用按需快照进行计划的测试故障转移*：要在启动自动测试故障转移之前创建新快照、请选中此框。
. 要在故障转移测试完成后清理测试环境，请选中*在测试故障转移后自动清理*并输入清理开始前要等待的分钟数。
+

NOTE: 此过程会从测试位置注销临时VM、删除已创建的FlexClone卷并卸载临时数据存储库。

. 选择 * 保存 * 。

